name: Build Bitcoin Puzzle Solver DMG

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build-dmg:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 ecdsa base58 requests flask qrcode Pillow
    
    - name: Install build tools
      run: |
        brew install cmake create-dmg
    
    - name: Clone and build BitCrack
      run: |
        git clone --depth 1 https://github.com/brichard19/BitCrack.git
        cd BitCrack
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_OPENCL=ON
        make -j$(sysctl -n hw.ncpu)
        mkdir -p ../../build/bin
        cp clBitCrack ../../build/bin/ || echo "BitCrack build completed with warnings"
    
    - name: Create application bundle
      run: |
        chmod +x scripts/create_app_bundle.sh
        ./scripts/create_app_bundle.sh
    
    - name: Build DMG
      run: |
        chmod +x scripts/build_dmg.sh
        ./scripts/build_dmg.sh
    
    - name: Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="dev-$(date +%Y%m%d)"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Bitcoin Puzzle Solver v${{ steps.get_version.outputs.VERSION }}
        body: |
          # Bitcoin Puzzle Solver v${{ steps.get_version.outputs.VERSION }}
          
          ## ðŸŽ‰ What's New
          - Complete macOS application with GUI
          - GPU acceleration via BitCrack
          - All 78+ unsolved Bitcoin puzzles
          - Secure private key handling
          - Auto-transfer to your wallet
          
          ## ðŸ“¥ Installation
          1. Download `BitcoinPuzzleSolver-${{ steps.get_version.outputs.VERSION }}-macOS.dmg`
          2. Open the DMG file
          3. Drag BitcoinPuzzleSolver to Applications
          4. Launch and start solving!
          
          ## ðŸ” Security Features
          âœ… Private keys never exposed
          âœ… Local transaction signing
          âœ… Automatic fund transfer
          âœ… Open source & auditable
          
          ## ðŸ“‹ Requirements
          - macOS 11.0 or later
          - Python 3.9+
          - GPU with OpenCL/Metal
          
          ## ðŸ“– Documentation
          See README.md for detailed instructions.
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.get_version.outputs.VERSION }}...HEAD
        draft: false
        prerelease: false
    
    - name: Upload DMG to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./BitcoinPuzzleSolver-${{ steps.get_version.outputs.VERSION }}-macOS.dmg
        asset_name: BitcoinPuzzleSolver-${{ steps.get_version.outputs.VERSION }}-macOS.dmg
        asset_content_type: application/x-apple-diskimage
    
    - name: Upload checksums
      run: |
        cd dist
        shasum -a 256 *.dmg > checksums.txt
        cat checksums.txt
    
    - name: Upload Checksums to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/checksums.txt
        asset_name: checksums.txt
        asset_content_type: text/plain
    
    - name: Notify completion
      run: |
        echo "âœ… Build complete!"
        echo "ðŸ“¦ DMG created and uploaded to release"
        echo "ðŸ”— Users can download from: https://github.com/${{ github.repository }}/releases"
