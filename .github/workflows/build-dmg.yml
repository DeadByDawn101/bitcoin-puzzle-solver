# #!/bin/bash

# Quick fix script - run this to update your repo with the fixed workflow

cd bitcoin-puzzle-solver

echo "Updating GitHub Actions workflow with fixed version..."

# Update the workflow file
cat > .github/workflows/build-dmg.yml << 'WORKFLOW'
name: Build Bitcoin Puzzle Solver DMG

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-dmg:
    runs-on: macos-13  # Use specific macOS version
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 ecdsa base58 requests flask qrcode Pillow
        brew install cmake
    
    - name: Clone and build BitCrack
      continue-on-error: true  # Don't fail if BitCrack fails
      run: |
        echo "Cloning BitCrack..."
        git clone --depth 1 https://github.com/brichard19/BitCrack.git
        
        if [ -d "BitCrack" ] && [ -f "BitCrack/CMakeLists.txt" ]; then
          echo "Building BitCrack..."
          cd BitCrack
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_OPENCL=ON
          make -j$(sysctl -n hw.ncpu)
          
          mkdir -p ../../build/bin
          if [ -f "clBitCrack" ]; then
            cp clBitCrack ../../build/bin/
            echo "✓ BitCrack built successfully"
          fi
        else
          echo "⚠️  BitCrack clone failed or invalid structure"
        fi
    
    - name: Create app bundle
      run: |
        mkdir -p build/BitcoinPuzzleSolver.app/Contents/MacOS
        mkdir -p build/BitcoinPuzzleSolver.app/Contents/Resources
        
        # Copy source files
        cp -r src/* build/BitcoinPuzzleSolver.app/Contents/Resources/
        
        # Copy BitCrack if available
        if [ -f "build/bin/clBitCrack" ]; then
          cp build/bin/clBitCrack build/BitcoinPuzzleSolver.app/Contents/Resources/
        fi
        
        # Create Info.plist
        cat > build/BitcoinPuzzleSolver.app/Contents/Info.plist << 'PLIST'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>BitcoinPuzzleSolver</string>
    <key>CFBundleIdentifier</key>
    <string>com.btcpuzzle.solver</string>
    <key>CFBundleName</key>
    <string>Bitcoin Puzzle Solver</string>
    <key>CFBundleVersion</key>
    <string>1.0.0</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
</dict>
</plist>
PLIST
        
        # Create launcher
        cat > build/BitcoinPuzzleSolver.app/Contents/MacOS/BitcoinPuzzleSolver << 'LAUNCHER'
#!/bin/bash
cd "$(dirname "$0")/../Resources"
python3 gui.py
LAUNCHER
        
        chmod +x build/BitcoinPuzzleSolver.app/Contents/MacOS/BitcoinPuzzleSolver
        echo "✓ App bundle created"
    
    - name: Build DMG
      run: |
        # Get version
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="1.0.0"
        fi
        
        echo "Building DMG version $VERSION..."
        
        # Create staging
        mkdir -p dmg_staging
        cp -r build/BitcoinPuzzleSolver.app dmg_staging/
        ln -s /Applications dmg_staging/Applications
        
        cat > dmg_staging/README.txt << 'README'
Bitcoin Puzzle Solver

INSTALLATION:
1. Drag BitcoinPuzzleSolver to Applications
2. Launch from Applications
3. Enter your Bitcoin address
4. Start solving!

Support: github.com
README
        
        # Create DMG
        hdiutil create -volname "Bitcoin Puzzle Solver" \
          -srcfolder dmg_staging \
          -ov -format UDZO \
          "BitcoinPuzzleSolver-${VERSION}-macOS.dmg"
        
        echo "✓ DMG created"
        ls -lh BitcoinPuzzleSolver-*.dmg
    
    - name: Generate checksums
      run: |
        shasum -a 256 BitcoinPuzzleSolver-*.dmg > checksums.txt
        cat checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          BitcoinPuzzleSolver-*.dmg
          checksums.txt
        body: |
          ## Bitcoin Puzzle Solver
          
          **Download**: BitcoinPuzzleSolver-macOS.dmg
          
          **Install**: Open DMG → Drag to Applications
          
          See README for full documentation.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      if: "!startsWith(github.ref, 'refs/tags/')"
      with:
        name: BitcoinPuzzleSolver-DMG
        path: |
          BitcoinPuzzleSolver-*.dmg
          checksums.txt
WORKFLOW

echo "✓ Workflow updated"

# Commit and push
git add .github/workflows/build-dmg.yml
git commit -m "Fix: Update workflow to handle BitCrack build issues"
git push

echo ""
echo "✓ Fixed workflow pushed to GitHub!"
echo ""
echo "Next steps:"
echo "1. Delete the old failed tag:"
echo "   git push --delete origin v1.0.0"
echo ""
echo "2. Create a new tag:"
echo "   git tag v1.0.1"
echo "   git push origin v1.0.1"
echo ""
echo "3. Watch the build:"
echo "   https://github.com/YOUR_USERNAME/bitcoin-puzzle-solver/actions"
echo ""
