# name: Build Bitcoin Puzzle Solver DMG

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-dmg:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 ecdsa base58 requests flask qrcode Pillow
    
    - name: Install build tools
      run: |
        brew install cmake
    
    - name: Clone BitCrack
      run: |
        echo "Cloning BitCrack repository..."
        
        # Try multiple times with different methods
        for i in {1..3}; do
          if git clone --depth 1 https://github.com/brichard19/BitCrack.git; then
            echo "âœ“ Clone successful"
            break
          else
            echo "Retry $i/3 failed, waiting..."
            sleep 10
          fi
        done
        
        # Verify clone succeeded
        if [ ! -d "BitCrack" ]; then
          echo "ERROR: Failed to clone BitCrack"
          exit 1
        fi
        
        echo "âœ“ BitCrack cloned successfully"
        ls -la BitCrack/
    
    - name: Verify BitCrack structure
      run: |
        cd BitCrack
        echo "BitCrack directory contents:"
        ls -la
        
        if [ ! -f "CMakeLists.txt" ]; then
          echo "ERROR: CMakeLists.txt not found!"
          echo "Available files:"
          find . -type f -name "*.txt" -o -name "*.cmake"
          exit 1
        fi
        
        echo "âœ“ CMakeLists.txt found"
    
    - name: Build BitCrack
      run: |
        cd BitCrack
        
        echo "Creating build directory..."
        mkdir -p build
        cd build
        
        echo "Running CMake..."
        cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_OPENCL=ON
        
        echo "Compiling with make..."
        make -j$(sysctl -n hw.ncpu)
        
        echo "Build completed, checking for binary..."
        ls -la
        
        if [ -f "clBitCrack" ]; then
          echo "âœ“ clBitCrack binary found"
          file clBitCrack
        else
          echo "Warning: clBitCrack not found"
          echo "Available files:"
          find . -type f -executable
        fi
    
    - name: Copy BitCrack binary
      run: |
        mkdir -p build/bin
        
        if [ -f "BitCrack/build/clBitCrack" ]; then
          cp BitCrack/build/clBitCrack build/bin/
          echo "âœ“ BitCrack binary copied"
        elif [ -f "BitCrack/bin/clBitCrack" ]; then
          cp BitCrack/bin/clBitCrack build/bin/
          echo "âœ“ BitCrack binary copied from bin/"
        else
          echo "âš ï¸  BitCrack binary not found, DMG will build without it"
          echo "Users will need to install BitCrack separately"
          touch build/bin/BITCRACK_NOT_INCLUDED.txt
        fi
    
    - name: Create application bundle
      run: |
        chmod +x scripts/create_app_bundle.sh
        ./scripts/create_app_bundle.sh
    
    - name: Verify app bundle
      run: |
        if [ -d "build/BitcoinPuzzleSolver.app" ]; then
          echo "âœ“ App bundle created"
          ls -la build/BitcoinPuzzleSolver.app/Contents/
        else
          echo "ERROR: App bundle not created"
          exit 1
        fi
    
    - name: Build DMG
      run: |
        chmod +x scripts/build_dmg.sh
        
        # Get version from tag or use default
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          export VERSION=${GITHUB_REF#refs/tags/v}
        else
          export VERSION="1.0.0"
        fi
        
        echo "Building DMG version: $VERSION"
        ./scripts/build_dmg.sh
        
        # Verify DMG was created
        if ls BitcoinPuzzleSolver-*.dmg 1> /dev/null 2>&1; then
          echo "âœ“ DMG created successfully"
          ls -lh BitcoinPuzzleSolver-*.dmg
        else
          echo "ERROR: DMG not created"
          exit 1
        fi
    
    - name: Generate checksums
      run: |
        shasum -a 256 BitcoinPuzzleSolver-*.dmg > checksums.txt
        cat checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          BitcoinPuzzleSolver-*.dmg
          checksums.txt
        body: |
          ## ðŸ” Bitcoin Puzzle Solver
          
          ### ðŸ“¥ Installation
          
          1. Download `BitcoinPuzzleSolver-macOS.dmg`
          2. Open the DMG file
          3. Drag BitcoinPuzzleSolver to Applications folder
          4. Launch from Applications
          5. Enter your Bitcoin wallet address
          6. Select a puzzle and start solving!
          
          ### âœ¨ Features
          
          - âœ… Beautiful native macOS GUI
          - âœ… GPU acceleration support
          - âœ… All 78+ unsolved puzzles
          - âœ… Secure private key handling
          - âœ… Auto-transfer to your wallet
          - âœ… No external dependencies
          
          ### ðŸ”’ Security
          
          - Private keys NEVER exposed publicly
          - Transaction signing done locally
          - Automatic fund transfer
          - Open source & auditable
          
          ### ðŸ“‹ Requirements
          
          - macOS 11.0 (Big Sur) or later
          - Python 3.9+
          - GPU with OpenCL/Metal support
          - Internet connection
          
          ### ðŸ†˜ Troubleshooting
          
          **"App cannot be opened"**
          - Right-click â†’ Open
          - Or: System Preferences â†’ Security â†’ Allow
          
          **Python not found**
          - Install from python.org
          
          **GPU not detected**
          - Check System Information â†’ Graphics
          
          ### ðŸ“– Documentation
          
          See README.md for detailed instructions.
          
          ### âš ï¸ Disclaimer
          
          Educational software. Success not guaranteed. 
          Monitor electricity costs and GPU temperatures.
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ github.event.release.tag_name }}...HEAD
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts (if not a tag)
      uses: actions/upload-artifact@v3
      if: "!startsWith(github.ref, 'refs/tags/')"
      with:
        name: BitcoinPuzzleSolver-DMG
        path: |
          BitcoinPuzzleSolver-*.dmg
          checksums.txt
        retention-days: 30
    
    - name: Build summary
      run: |
        echo "## âœ… Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts Created:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        for dmg in BitcoinPuzzleSolver-*.dmg; do
          if [ -f "$dmg" ]; then
            size=$(du -h "$dmg" | cut -f1)
            echo "- âœ… $dmg ($size)" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Checksums:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat checksums.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/bin/clBitCrack" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… BitCrack included" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸  BitCrack not included (users will need to install separately)" >> $GITHUB_STEP_SUMMARY
        fi
